---
title: "AR Fire Fertilization Results"
author: "Ian Klupar"
output: html_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)

# clear all
rm(list=ls())
if(!is.null(dev.list())) dev.off()
cat("\014")
library(tidyverse)

# function for computing standard error
s.err <- function(x){
  sd(x)/sqrt(length(x))
}

# from cookbook-r (if i decide to summarize data outside of ggplot)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE){
    library(plyr)
    length2 <- function (x, na.rm=FALSE){
        if (na.rm) sum(!is.na(x))
        else length(x)
    }

    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col){
        c(N = length2(xx[[col]], na.rm=na.rm),
          mean = mean(xx[[col]], na.rm=na.rm),
          sd = sd(xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )
    datac <- rename(datac, c("mean" = measurevar))
    datac$se <- datac$sd / sqrt(datac$N) 

    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult

    return(datac)
}

```
### Biomass
***
**File:** "burn_fertilization_biomass.csv"
```{r biomass, include=T}
library(modelr)
library(ggpubr)
options(na.action = na.warn)

biomass <- read.csv("/Users/ianklupar/Desktop/thesis-data/v2/organized/biomass/burn_fertilization_biomass.csv", header = T, stringsAsFactors = F)
biomass <- as_tibble(biomass)
```

##### Corrections by species:
***
*Eriophorum vaginatum*

 1.) fit a linear regression that predicts blade wt based on litter wt with poor
data exempt best fit line is: ev.blade[y] = 0.7 + 0.092 * ev.litter[x]  

2.) I calculated expected blade based off of calculated litter weight and 
then "moved" the difference between "observed" and predicted into the litter 
category.  

Therefore, "ev.blade" for U-B4-C, S-B4-P, U-B1-N, U-B4-P were all recalculated based on the amount of litter. 

```{r biomass corrections: erivag, include=T}

# correct high "ev.blade" values based on "ev.litter"
ev.correct <- select(biomass, site:treatment, ev.blade, ev.litter) %>% 
  mutate(sum = ev.blade + ev.litter)

# plot and linear model without over estimated values
ggplot(ev.correct[-c(25,30,37,49),], aes(y=ev.blade, x=ev.litter))+
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation()

list <- c(25, 30, 37, 49)
for(i in list){
 biomass[i,"ev.litter"] <- (ev.correct[i,"sum"]-0.7)/1.092
 biomass[i,"ev.blade"] <- 0.7 + 0.092*biomass[i,"ev.litter"] 
}

ggplot(biomass, aes(y=ev.blade, x=ev.litter)) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F)   

rm(i, list, ev.correct)
```
  
*Petasites frigidus*

```{r biomass correction: petfri, eval=FALSE, include=FALSE}

# S-B4-C high "pf.above" value
# remeasured weight using g = LAI/SLA; LAI=3.42, SLA(R.chamamourus)=0.01538

biomass[5,"pf.above"] <- 5.87
```

*Vaccinium vitis-idea*

Change V.vitis-idea values. Some plots had 1.) Old growth, but no new growth or 
 2.) New growth that was greater than old growth. Both scenarios are unlikely.
 To correct, I generated a new growth/old growth ratio for each plot and took
 the median value from the data. I then used this ratio to generate a value for 
 the new growth that wasn't there. For plots that had more new growth than old growth
 I summed the two values to simulate "no new growth" and preformed the above.   
 
Plots that had old growth but no new growth:
 SB1C,SB3NP  
 
Plots that had new growth > old growth:
 SB1P, SB2P, SB4P, SB0N, SB1NP, SB2NP, SB4NP, UB0C, UB0P, UB3P, UB0N, UB4NP  
 
Median Ratio = 0.5326087

```{r biomass correction: vacvit, include=F}

ggplot(biomass, aes(y=vv.newgrowth, x=vv.oldgrowth))+
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation() 

vv.correct <- anti_join(select(biomass, site:treatment,vv.newgrowth, vv.oldgrowth), 
                       select(biomass,site:treatment, vv.newgrowth, vv.oldgrowth) %>%
                          filter((vv.newgrowth > 2*vv.oldgrowth))) 

ggplot(vv.correct, aes(y=vv.newgrowth, x=vv.oldgrowth)) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation()

vv.correct <- select(biomass, site:treatment,vv.newgrowth, vv.oldgrowth) %>% 
  mutate(sum = vv.newgrowth + vv.oldgrowth)

# y = 0.37 + 0.2 x
list <- which((biomass["vv.newgrowth"] > 2*biomass["vv.oldgrowth"]))
count <- 0
for (i in list){
  biomass[i,"vv.oldgrowth"] <- (vv.correct[i,"sum"] - 0.37) / 1.2
  biomass[i,"vv.newgrowth"] <- 0.37 + 0.2 * biomass[i,"vv.oldgrowth"]
  count = count + 1
}
print(count)

ggplot(biomass, aes(y=vv.newgrowth, x=vv.oldgrowth))+
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation()

rm(i, list, vv.correct)
```

*Ledum palustre*

L. palustre was sepereated incorrectly. Some had all leaves categorized as new growth where
 others had new growth with no corresponding old growth. Both scenarios are incorrect, so 
 in an attempt to correct it, I further seperated each bag originally labeled "new growth" and "old growth"
 into leaves and stems. This left me with values for "old leaves"" and "old stems"" and "new leaves" 
 and "new stems". From this, I isolated plots which had newLeaves > oldLeaves, which is a sign of
 poor seperation. Then I grouped together oldLeaves, oldStems, newStems and categorized that as 
 "old growth". From this, I determined a correct ratio for old to new and applied that ratio to
 only the plots that had newLeaves > oldLeaves.  
 
```{r biomass correction: ledpal, include=F, echo=F}

ggplot(biomass, aes(y=(lp.newgrowth.leaves + lp.newgrowth.stems) ,
                    x=(lp.oldgrowth.leaves +lp.oldgrowth.stems))) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F)

lp.correct <- anti_join(select(biomass, site:treatment, grep("lp.*", colnames(biomass))),
          select(biomass, site:treatment, grep("lp.*", colnames(biomass))) %>% 
  filter(lp.oldgrowth.leaves < lp.newgrowth.leaves)) %>%
  mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
         lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
         sum = lp.oldgrowth + lp.newgrowth)

ggplot(lp.correct, aes(y=lp.newgrowth ,x=lp.oldgrowth)) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation()

biomass <- biomass %>% 
  mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
         lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
         lp.sum = (lp.oldgrowth + lp.newgrowth))

# y = 0.21 + 0.12 x
list <- which((biomass["lp.newgrowth.leaves"] > biomass["lp.oldgrowth.leaves"]))
count <- 0
for(i in list){
  biomass[i,"lp.oldgrowth"] <- (biomass[i,"lp.sum"] - 0.21)/1.21
  biomass[i,"lp.newgrowth"] <- 0.21 + 0.12 * biomass[i,"lp.oldgrowth"]
  count <- count + 1
}
print(count)

ggplot(biomass, aes(y=lp.newgrowth,x=lp.oldgrowth)) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation()

biomass <- select(biomass, -lp.newgrowth.leaves, -lp.newgrowth.stems, -lp.oldgrowth.leaves,
                  -lp.oldgrowth.stems, -lp.sum)

rm(i, count, list, lp.correct)
```


```{r biomass scaling, include=F}
# If i want to produce graphs without corrections
# biomass <- biomass %>%
#   mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
#          lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
#          lp.sum = (lp.oldgrowth + lp.newgrowth))
# biomass <- select(biomass, -lp.newgrowth.leaves, -lp.newgrowth.stems, -lp.oldgrowth.leaves,
#                   -lp.oldgrowth.stems, -lp.sum)

small_quad_spp <- c("ev.blade","ev.litter","ev.infl","ev.rhizome","ev.roots","ev.dead.sheath",
                    "ev.decomp.sheath","ev.tussockom","cb.blade","cb.litter","cb.sheath","cb.infl","cb.rhizome",
                    "cb.liveroots","cb.deadroots","vv.newgrowth","vv.oldgrowth","vv.infl","ct.newgrowth",
                    "ct.oldgrowth","ct.dead","ap.newgrowth","ap.oldgrowth","rc.above","rc.litter","rc.below",
                    "rc.infl","pf.above","pf.below","pf.litter","fine.roots","coarse.roots","moss","lichen",
                    "fungi","evergr.litter","decid.litter")

large_quad_spp <- c("bn.leaves","bn.newstems","bn.oldstem","bn.below","bn.infl","sp.newstem","sp.leaves",
                    "sp.oldstem","lp.newgrowth","lp.oldgrowth","lp.dead","lp.infl","lp.below")

biomass[small_quad_spp] <- select(biomass, small_quad_spp) * 25
biomass[large_quad_spp] <- select(biomass, large_quad_spp) * 4

biomass$treatment[biomass$treatment=="CX"] <- "C"

rm(small_quad_spp,large_quad_spp)
```
#### Final Biomass Data

```{r complete biomass and productivity data}

pft.biomass <- mutate(biomass, 
                            sedge = ev.blade + ev.rhizome + cb.blade + cb.rhizome,
                            decid = bn.leaves + bn.newstems + bn.oldstem + bn.infl + sp.leaves + sp.newstem +
                              sp.oldstem,
                            evergr = vv.newgrowth + vv.oldgrowth + vv.infl + ct.newgrowth + ct.oldgrowth +
                              lp.newgrowth + lp.oldgrowth + lp.infl + ap.newgrowth + ap.oldgrowth,
                            forb = rc.above + rc.litter + pf.above) %>% 
                     select(site:treatment, sedge:forb)

pft.anpp <- mutate(biomass,
                     sedge = ev.blade + ev.infl + cb.blade + cb.infl,
                     decid = bn.leaves + bn.newstems + bn.infl + sp.newstem + sp.leaves,
                     evergr = vv.newgrowth + vv.infl + lp.newgrowth + lp.infl + ct.newgrowth +
                       ap.newgrowth,
                     forb = rc.above + rc.litter + pf.above)%>% 
                  select(site:treatment,sedge:forb)
```
#### Biomass Graphs

```{r productivity percents & correlations}
pft.anpp %>% 
  filter(site=="S") %>% 
  gather(sedge:forb, key="pft", value = "anpp") %>% 
  ggplot(aes(fill=pft, y=anpp, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("severe anpp")

pft.anpp %>% 
  filter(site=="U") %>% 
  gather(sedge:forb, key="pft", value = "anpp") %>% 
  ggplot(aes(fill=pft, y=anpp, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("unburned anpp")

pft.biomass %>% 
  filter(site=="S") %>% 
  gather(sedge:forb, key="pft", value = "biomass") %>% 
  ggplot(aes(fill=pft, y=biomass, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("severe biomass")

pft.biomass %>% 
  filter(site=="U") %>% 
  gather(sedge:forb, key="pft", value = "biomass") %>% 
  ggplot(aes(fill=pft, y=biomass, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("unburned biomass")

pft.anpp %>% 
  filter(site=="S") %>% 
  ggplot(aes(x=decid, y=forb, color=treatment, shape=treatment))+
  geom_point()+
  geom_smooth(method = stats::lm, se = F, fullrange = T)+
  ggtitle("")

```

```{r productivity bar graphs w/error bars}
pft.anpp %>% 
  ggplot(aes(x = treatment, y = decid, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_se, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  ggtitle("Decid productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = sedge, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_se, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  ggtitle("Sedge productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = evergr, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_se, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  ggtitle("Evergr productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = forb, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_se, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  ggtitle("Forb productivity -- g/m2")



```













