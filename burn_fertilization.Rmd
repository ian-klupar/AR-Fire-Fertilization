---
title: "AR Fire Fertilization Results"
author: "Ian Klupar"
output: html_document
---

```{r setup, echo=T, include=F, results='hide'}
knitr::opts_chunk$set(echo = TRUE)

# clear all
rm(list=ls())
if(!is.null(dev.list())) dev.off()
cat("\014")


# function for computing standard error
s.err <- function(x){
  sd(x)/sqrt(length(x))
}

```

```{r biomass, echo=F, include=T, results='hide'}
library(tidyverse)
library(modelr)
library(ggpubr)

options(na.action = na.warn)

biomass <- read.csv("/Users/ianklupar/Desktop/thesis-data/v2/organized/biomass/burn_fertilization_biomass.csv",
                    header = T, stringsAsFactors = F)
biomass <- as_tibble(biomass)
```
### **Biomass**
***
##### Corrections by species:
*Eriophorum vaginatum*

 Fit a linear regression with outliers exempt.  
 Best fit line is: ev.blade[y] = 0.7 + 0.092 * ev.litter[x]  

"ev.blade" for U-B4-C, S-B4-P, U-B1-N, U-B4-P were all re-adjusted based on the amount of litter. 

```{r biomass corrections: erivag, echo=T, results='hide'}

# correct high "ev.blade" values based on "ev.litter"
ev.correct <- select(biomass, site:treatment, ev.blade, ev.litter) %>%
  mutate(sum = ev.blade + ev.litter)
ev.correct <- ev.correct[-c(25,30,37,49),]

# plot and linear model without over estimated values
ev.lm <- lm(ev.blade~ev.litter,ev.correct)
predict(ev.lm, ev.correct, interval="confidence")

biomass <- biomass %>%
  mutate(sum = (ev.blade + ev.litter))

list <- c(25, 30, 37, 49)
for(i in list){
 biomass[i,"ev.litter"] <- (biomass[i,"sum"]-0.7)/1.092
 biomass[i,"ev.blade"] <- 0.70565 + 0.09199*biomass[i,"ev.litter"]
}

biomass <- select(biomass, -sum)
rm(i, list, ev.correct)
```
  
*Petasites frigidus*

```{r biomass correction: petfri, echo=T, results='hide'}

# S-B4-C high "pf.above" value
# remeasured weight using g = LAI/SLA; LAI=3.42, SLA(R.chamamourus)=0.01538

biomass[5,"pf.above"] <- 5.87
```

*Vaccinium vitis-idea*

Plots where new growth was twice as great as old growth were considered to be poorly seperated.
To correct for this, a regression was generated with poor data exepmt. Poor data was then corrected using the
generated regression.
 
Plots that had old growth but no new growth:
 SB1C,SB3NP  
 
Plots that had new growth > old growth:
 SB1P, SB2P, SB4P, SB0N, SB1NP, SB2NP, SB4NP, UB0C, UB0P, UB3P, UB0N, UB4NP  

```{r biomass correction: vacvit, echo=T, results='hide'}

biomass <- biomass %>%
  mutate(sum = (vv.oldgrowth + vv.newgrowth))

biomass %>%
  filter(biomass["vv.newgrowth"] <= 2*biomass["vv.oldgrowth"]) %>%
  lm(vv.newgrowth~vv.oldgrowth, data = .)
# y = 0.3414 + 0.2380 x

list <- which((biomass["vv.newgrowth"] > 2*biomass["vv.oldgrowth"]))

for (i in list){
  biomass[i,"vv.oldgrowth"] <- (biomass[i,"sum"] - 0.3414) / 1.238
  biomass[i,"vv.newgrowth"] <- 0.3414 + (0.238 * biomass[i,"vv.oldgrowth"])
}

biomass <- select(biomass, -sum)
rm(i, list)
```

*Ledum palustre*
 
```{r biomass correction: ledpal, echo=T, results='hide'}
biomass <- biomass %>%
  mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
         lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
         sum = (lp.oldgrowth + lp.newgrowth))

biomass %>%
  filter(biomass["lp.newgrowth.leaves"] < biomass["lp.oldgrowth.leaves"]) %>%
  lm(lp.newgrowth~lp.oldgrowth, data = .)
# y = 0.2354 + 0.1196 x

list <- which((biomass["lp.newgrowth.leaves"] > biomass["lp.oldgrowth.leaves"]))
for(i in list){
  biomass[i,"lp.oldgrowth"] <- (biomass[i,"sum"] - 0.2354)/1.1196
  biomass[i,"lp.newgrowth"] <- 0.2354 + 0.1196 * biomass[i,"lp.oldgrowth"]
}

biomass <- select(biomass, -sum, -lp.newgrowth.leaves, -lp.newgrowth.stems, -lp.oldgrowth.leaves,
                  -lp.oldgrowth.stems)
rm(i, list)
```


```{r biomass scaling, echo=T, results='hide'}
# If i want to produce graphs without corrections

# biomass <- biomass %>%
#   mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
#          lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
#          lp.sum = (lp.oldgrowth + lp.newgrowth))
# biomass <- select(biomass, -lp.newgrowth.leaves, -lp.newgrowth.stems, -lp.oldgrowth.leaves,
#                   -lp.oldgrowth.stems, -lp.sum)

small_quad_spp <- c("ev.blade","ev.litter","ev.infl","ev.rhizome","ev.roots","ev.dead.sheath",
                    "ev.decomp.sheath","ev.tussockom","cb.blade","cb.litter","cb.sheath","cb.infl","cb.rhizome",
                    "cb.liveroots","cb.deadroots","vv.newgrowth","vv.oldgrowth","vv.infl","ct.newgrowth",
                    "ct.oldgrowth","ct.dead","ap.newgrowth","ap.oldgrowth","rc.above","rc.litter","rc.below",
                    "rc.infl","pf.above","pf.below","pf.litter","fine.roots","coarse.roots","moss","lichen",
                    "fungi","evergr.litter","decid.litter")

large_quad_spp <- c("bn.leaves","bn.newstems","bn.oldstem","bn.below","bn.infl","sp.newstem","sp.leaves",
                    "sp.oldstem","lp.newgrowth","lp.oldgrowth","lp.dead","lp.infl","lp.below")

biomass[small_quad_spp] <- select(biomass, small_quad_spp) * 25
biomass[large_quad_spp] <- select(biomass, large_quad_spp) * 4

biomass$treatment[biomass$treatment=="CX"] <- "C"

rm(small_quad_spp,large_quad_spp)
```
#### Final Biomass Data

```{r complete biomass and productivity data}

pft.biomass <- mutate(biomass, 
                      sedge = ev.blade + ev.rhizome + ev.infl + cb.blade + cb.rhizome + cb.infl,
                      decid = bn.leaves + bn.newstems + bn.oldstem + bn.infl + sp.leaves + sp.newstem +
                              sp.oldstem,
                      evergr = vv.newgrowth + vv.oldgrowth + vv.infl + ct.newgrowth + ct.oldgrowth +
                              lp.newgrowth + lp.oldgrowth + lp.infl + lp.dead + ap.newgrowth + ap.oldgrowth,
                      forb = rc.above + rc.litter + pf.above,
                      nonv = moss + lichen,
                      litter  = evergr.litter + decid.litter + rc.litter + pf.litter,
                      biomass = sedge + decid + evergr + forb) %>% 
               select(site:treatment, sedge:biomass)

pft.biomass$site <- as.factor(pft.biomass$site)
pft.biomass$treatment <- as.factor(pft.biomass$treatment)

pft.anpp <- mutate(biomass,
                     sedge = ev.blade + ev.infl + cb.blade + cb.infl,
                     decid = bn.leaves + bn.newstems + bn.infl + sp.newstem + sp.leaves,
                     evergr = vv.newgrowth + vv.infl + lp.newgrowth + lp.infl + ct.newgrowth +
                       ap.newgrowth,
                     forb = rc.above + rc.infl + pf.above,
                     anpp = sedge + decid + evergr + forb) %>% 
                  select(site:treatment,sedge:anpp)

pft.anpp$site <- as.factor(pft.anpp$site)
pft.anpp$treatment <- as.factor(pft.anpp$treatment)
```

```{r ANOVA and Kruskal-Wallis Test}

pft.anpp %>% filter() %>%
  aov(total ~ Error(block) + site*treatment, data = .) %>% 
  summary()

pft.biomass %>% filter() %>%
  aov(total ~ Error(block) + site*treatment, data = .) %>% 
  summary()

# Does severe C biomass = unbured C biomass?
pft.biomass %>% filter(treatment=="C") %>% 
  kruskal.test(total ~ site, data = .)

# Does severe C anpp = unburned C anpp?
pft.anpp %>% filter(treatment=="C") %>% 
  kruskal.test(total ~ site, data = .)

# Is anpp the same for all severe treatments?
pft.anpp %>% filter(site=="S") %>% 
  kruskal.test(total ~ treatment, data = .)

# Is anpp the same for all unburned treatments?
pft.anpp %>% filter(site=="U") %>% 
  kruskal.test(total ~ treatment, data = .)

aggregate(total ~ block + site + treatment, mean, data = pft.biomass)

treat_aov <- function(data_frame, measurement){
  mF <- formula(paste(measurement, " ~ as.factor(block) + site * treatment")) 
  m <- aov(mF, data = data_frame)
  print(summary(m))
  #return(TukeyHSD(m))
}
treat_aov(pft.anpp, "total")

model <- lm(anpp ~ site/as.factor(block)+treatment+site:treatment, data=pft.anpp)
summary(model)

pft.biomass %>%  select(site:treatment, biomass)

```

#### Biomass Graphs
```{r productivity percents & correlations}

pft.anpp %>% 
  gather(sedge:forb, key="pft", value = "anpp") %>% 
  ggplot(aes(fill=pft, y=anpp, x=treatment)) +
  geom_bar(position = "fill",stat = "identity", width = 0.5) +
  facet_grid(.~site) + 
  ggtitle("percent total productivity") +
  scale_fill_brewer(palette="Spectral")

pft.biomass %>% 
  gather(sedge:forb, key="pft", value = "biomass") %>% 
  ggplot(aes(fill=pft, y=biomass, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  facet_grid(.~site) + 
  ggtitle("percent total biomass") +
  scale_fill_brewer(palette="Spectral")



```

```{r productivity bar graphs with error bars}
my_comparisons <- list( c("C", "N"), c("C", "NP"), c("C", "P"))

pft.anpp %>% 
  ggplot(aes(x = treatment, y = total, fill=site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_se, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.format", label.y = -10, method = "t.test") +
  ggtitle("total productivity -- g/m2")

pft.anpp %>% 
  filter(site=="U") %>% 
  ggbarplot(x = "treatment" ,y = "total", add = c("mean_sd","jitter"),
            ggtheme = theme_light(),
            position = position_dodge(0.8), width = 0.5)+
  stat_compare_means(aes(group = treatment), label = "p.format", method = "anova") + 
  stat_compare_means(ref.group = "C", label = "p.format", label.y = -12, method = "t.test")+
  ggtitle("unburned -- total productivity") +
  ggrepel::geom_text_repel(aes(label = block))

pft.anpp %>% 
  filter(site=="S") %>% 
  ggbarplot(x = "treatment" ,y = "total", add = c("mean_sd","jitter"),
            ggtheme = theme_light(),
            position = position_dodge(0.8), width = 0.5)+
  stat_compare_means(aes(group = treatment), label = "p.format", method = "anova") + 
  stat_compare_means(ref.group = "C", label = "p.format", label.y = -12, method = "t.test") +
  ggtitle("severe -- total productivity") +
  ggrepel::geom_text_repel(aes(label = block))

biomass %>% 
  filter(site=="S", block == 3, treatment == "NP")

```

```{r productivity bar graphs w/error bars}
pft.anpp %>% 
  filter(treatment=="C") %>% 
  ggbarplot(x = "site" ,y = "total", add = c("mean_sd","jitter"),
            ggtheme = theme_light(), width = 0.5) + 
  stat_compare_means(ref.group = "S", label = "p.format", label.y = 15, method = "t.test")+
  ggtitle("total C productivity")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = decid, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("decid productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = sedge, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("sedge productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = evergr, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("evergr productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = forb, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("forb productivity -- g/m2")
```
### **reflectance**
***
```{r reflectance, include=F, results='hide'}
options(na.action = na.warn)

reflectance <- read_csv("/Users/ianklupar/Desktop/thesis-data/v2/organized/reflectance/burn_fertilization_reflectance.csv")
reflectance <- as_tibble(reflectance)
```










