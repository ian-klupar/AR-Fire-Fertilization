---
title: "AR Fire Fertilization Results"
author: "Ian Klupar"
output: html_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)

# clear all
rm(list=ls())
if(!is.null(dev.list())) dev.off()
cat("\014")
library(tidyverse)

```
### Biomass
**File:** "burn_fertilization_biomass.csv"

##### Corrections by species:
###### Eriophorum vaginatum  

 1.) fit a linear regression that predicts blade wt based on litter wt with poor
data exempt best fit line is: ev.blade[y] = 0.7 + 0.092 * ev.litter[x]  

2.) I calculated expected blade based off of calculated litter weight and 
then "moved" the difference between "observed" and predicted into the litter 
category.  

Therefore, "ev.blade" for U-B4-C, S-B4-P, U-B1-N, U-B4-P were all recalculated based on the amount of litter. 

```{r biomass corrections: erivag, include=F}
library(modelr)
library(ggpubr)
options(na.action = na.warn)

biomass <- read.csv("/Users/ianklupar/Desktop/thesis-data/v2/organized/biomass/burn_fertilization_biomass.csv", header = T, stringsAsFactors = F)
biomass <- as_tibble(biomass)

# correct high "ev.blade" values based on "ev.litter"
ev.correct <- select(biomass, site:treatment, ev.blade, ev.litter)

# plot and linear model without over estimated values
ggplot(ev.correct[-c(25,30,37,49),], aes(y=ev.blade, x=ev.litter))+
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation()

biomass[25,"ev.blade"] <- 0.7 + 0.092 * biomass[25,"ev.litter"]
biomass[30,"ev.blade"] <- 0.7 + 0.092 * biomass[30,"ev.litter"]
biomass[37,"ev.blade"] <- 0.7 + 0.092 * biomass[37,"ev.litter"]
biomass[49,"ev.blade"] <- 0.7 + 0.092 * biomass[49,"ev.litter"]

ev.correct <- select(biomass, site:treatment, ev.blade, ev.litter)
ggplot(ev.correct, aes(y=ev.blade, x=ev.litter))+
  geom_point() +
  geom_smooth(method = stats::lm, se = F)   

rm(ev.correct)
```
  
###### Petasites frigidus

```{r biomass correction: petfri, include=F}

# S-B4-C high "pf.above" value
# remeasured weight using g = LAI/SLA; LAI=3.42, SLA(R.chamamourus)=0.01538

biomass[5,"pf.above"] <- 5.87
```

###### Vaccinium vitis-idea  

Change V.vitis-idea values. Some plots had 1.) Old growth, but no new growth or 
 2.) New growth that was greater than old growth. Both scenarios are unlikely.
 To correct, I generated a new growth/old growth ratio for each plot and took
 the median value from the data. I then used this ratio to generate a value for 
 the new growth that wasn't there. For plots that had more new growth than old growth
 I summed the two values to simulate "no new growth" and preformed the above.   
 
Plots that had old growth but no new growth:
 SB1C,SB3NP  
 
Plots that had new growth > old growth:
 SB1P, SB2P, SB4P, SB0N, SB1NP, SB2NP, SB4NP, UB0C, UB0P, UB3P, UB0N, UB4NP  
 
Median Ratio = 0.5326087

```{r biomass correction: vacvit, include=F}

# New values should match the ratio of correctly plucked plots (0.5326087)
select(biomass, vv.newgrowth, vv.oldgrowth) %>%
  filter(vv.newgrowth > 0 & vv.oldgrowth > 0) %>%
  mutate(ratio = vv.newgrowth/vv.oldgrowth) %>% 
  arrange(ratio) %>% 
  summarise(ratio = median(ratio))

# Find the multiplier for plots that were plucked correctly (0.3472222)
select(biomass, vv.newgrowth, vv.oldgrowth) %>%
  filter(vv.newgrowth > 0 & vv.oldgrowth > 0) %>%
  mutate(multiplier = vv.newgrowth/(vv.newgrowth + vv.oldgrowth)) %>% 
  arrange(multiplier) %>% 
  summarise(multiplier = mean(multiplier))
# 0.3472222

# Correct plots that either 1.) vv.newgrowth > vv.oldgrowth or 2.) have vv.oldgrowth values and no vv.newgrowth
vv.correct <- select(biomass, site:treatment, vv.newgrowth, vv.oldgrowth) %>% 
  filter((vv.newgrowth == 0 & vv.oldgrowth != 0)|(vv.newgrowth >  vv.oldgrowth)) %>%
  mutate(vv.newgrowth_cor = (vv.newgrowth + vv.oldgrowth)*0.3472222,
            vv.oldgrowth_cor = (vv.newgrowth + vv.oldgrowth) - vv.newgrowth_cor,
         totals_cor = vv.newgrowth_cor + vv.oldgrowth_cor) %>%
  select(site:treatment, vv.newgrowth_cor, vv.oldgrowth_cor)

# Replace bad values with corrected values
biomass <- left_join(biomass, vv.correct) %>%
  mutate(vv.newgrowth = coalesce(vv.newgrowth_cor, vv.newgrowth)) %>%
  mutate(vv.oldgrowth = coalesce(vv.oldgrowth_cor, vv.oldgrowth)) %>%
  select(-vv.newgrowth_cor, -vv.oldgrowth_cor)
  
rm(vv.correct)
```

###### Ledum palustre  

L. palustre was sepereated incorrectly. Some had all leaves categorized as new growth where
 others had new growth with no corresponding old growth. Both scenarios are incorrect, so 
 in an attempt to correct it, I further seperated each bag originally labeled "new growth" and "old growth"
 into leaves and stems. This left me with values for "old leaves"" and "old stems"" and "new leaves" 
 and "new stems". From this, I isolated plots which had newLeaves > oldLeaves, which is a sign of
 poor seperation. Then I grouped together oldLeaves, oldStems, newStems and categorized that as 
 "old growth". From this, I determined a correct ratio for old to new and applied that ratio to
 only the plots that had newLeaves > oldLeaves.  
 
```{r biomass correction: ledpal, include=F}

ggplot(biomass, aes(y=(lp.newgrowth.leaves + lp.newgrowth.stems) ,
                    x=(lp.oldgrowth.leaves +lp.oldgrowth.stems))) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F)

# median "newgrowth.leaves":"old" for plots that agree with the condition lp.newgrowth.leaves < lp.oldgrowth.leaves (my way of determining if the plot was seperated poorly)
select(biomass, grep("lp.*", colnames(biomass))) %>% 
  filter(lp.oldgrowth.leaves > lp.newgrowth.leaves) %>%
  mutate(lp.old = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
         lp.new = (lp.newgrowth.leaves + lp.newgrowth.stems),
         ratio = (lp.new / lp.old),
         multiplier = lp.new / (lp.new + lp.old)) %>%
  arrange(ratio) %>%
  summarise(ratio = median(ratio, na.rm = T),
            multiplier = median(multiplier, na.rm = T))

# median new < old ratio: 0.1216216
# median new > old ratio: 0.6486691
# multiplier = 0.1084337
  
lp.correct <- select(biomass, site:treatment, grep("lp.*", colnames(biomass))) %>% 
  filter(lp.oldgrowth.leaves == 0 | lp.oldgrowth.leaves < lp.newgrowth.leaves) %>%
  mutate(lp.old = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
         lp.new = (lp.newgrowth.leaves + lp.newgrowth.stems),
         lp.newgrowth_cor = (lp.old + lp.new) * 0.1084337,
         lp.oldgrowth_cor = (lp.old + lp.new) - lp.newgrowth_cor,
         sum1 = lp.newgrowth_cor + lp.oldgrowth_cor,
         sum2 = lp.new + lp.old) %>%
  select(site:treatment, lp.newgrowth_cor, lp.oldgrowth_cor)

biomass <- left_join(biomass, lp.correct) %>% 
  mutate(lp.newgrowth = lp.newgrowth.leaves + lp.newgrowth.stems,
         lp.oldgrowth = lp.oldgrowth.leaves + lp.oldgrowth.stems) %>% 
  mutate(lp.newgrowth = coalesce(lp.newgrowth_cor, lp.newgrowth),
         lp.oldgrowth = coalesce(lp.oldgrowth_cor, lp.oldgrowth)) %>% 
  select(-lp.newgrowth.leaves:-lp.oldgrowth.stems, -lp.newgrowth_cor, -lp.oldgrowth_cor)

ggplot(biomass, aes(y=lp.newgrowth,x=lp.oldgrowth)) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F)

rm(lp.correct)
```

```{r biomass, include=F}
small_quad_spp <- c("ev.blade","ev.litter","ev.infl","ev.rhizome","ev.roots","ev.dead.sheath",
                    "ev.decomp.sheath","ev.tussockom","cb.blade","cb.litter","cb.sheath","cb.infl","cb.rhizome",
                    "cb.liveroots","cb.deadroots","vv.newgrowth","vv.oldgrowth","vv.infl","ct.newgrowth",
                    "ct.oldgrowth","ct.dead","ap.newgrowth","ap.oldgrowth","rc.above","rc.litter","rc.below",
                    "rc.infl","pf.above","pf.below","pf.litter","fine.roots","coarse.roots","moss","lichen",
                    "fungi","evergr.litter","decid.litter")

large_quad_spp <- c("bn.leaves","bn.newstems","bn.oldstem","bn.below","bn.infl","sp.newstem","sp.leaves",
                    "sp.oldstem","lp.newgrowth","lp.oldgrowth","lp.dead","lp.infl","lp.below")

biomass[small_quad_spp] <- select(biomass, small_quad_spp) * 25
biomass[large_quad_spp] <- select(biomass, large_quad_spp) * 4
rm(small_quad_spp,large_quad_spp)

biomass_spp_anpp <- mutate(biomass, 
                      ev.anpp = ev.blade + ev.infl,
                      cb.anpp = cb.blade + cb.infl,
                      bn.anpp = bn.leaves + bn.newstems + bn.infl,
                      sp.anpp = sp.newstem + sp.leaves,
                      vv.anpp = vv.newgrowth + vv.infl,
                      lp.anpp = lp.newgrowth + lp.infl,
                      ct.anpp = ct.newgrowth,
                      ap.anpp = ap.newgrowth,
                      rc.anpp = rc.above + rc.litter + rc.litter,
                      pf.anpp = pf.above) %>% 
                   select(site:treatment, ev.anpp:pf.anpp)

biomass_ft_anpp <- mutate(biomass_spp_anpp,
                     sedge.anpp = ev.anpp + cb.anpp,
                     decid.anpp = bn.anpp + sp.anpp,
                     evergr.anpp = vv.anpp + ct.anpp + lp.anpp + ap.anpp,
                     forb.anpp = rc.anpp + pf.anpp) %>% 
                  select(site:treatment, sedge.anpp:forb.anpp)

biomass_total <- mutate(biomass_ft_anpp,
                           total = sedge.anpp + decid.anpp + evergr.anpp + forb.anpp) %>% 
                select(site:treatment, total)

by_treatment <- group_by(biomass_ft_anpp, site, block, treatment)
summarise(by_treatment)
```













