---
title: "AR Fire Fertilization Results"
author: "Ian Klupar"
output: html_document
---

```{r setup, echo=F, include=F, results='hide'}
knitr::opts_chunk$set(echo = TRUE)

# clear all
rm(list=ls())
if(!is.null(dev.list())) dev.off()
cat("\014")


# function for computing standard error
s.err <- function(x){
  sd(x)/sqrt(length(x))
}

```


```{r biomass, include=F, results='hide'}
library(tidyverse)
library(modelr)
library(ggpubr)

options(na.action = na.warn)

biomass <- read.csv("/Users/ianklupar/Desktop/thesis-data/v2/organized/biomass/burn_fertilization_biomass.csv",
                    header = T, stringsAsFactors = F)
biomass <- as_tibble(biomass)
```
### **Biomass**
***
##### Corrections by species:
*Eriophorum vaginatum*

 Fit a linear regression with outliers exempt.  
 Best fit line is: ev.blade[y] = 0.7 + 0.092 * ev.litter[x]  

"ev.blade" for U-B4-C, S-B4-P, U-B1-N, U-B4-P were all re-adjusted based on the amount of litter. 

```{r biomass corrections: erivag}

# correct high "ev.blade" values based on "ev.litter"
ev.correct <- select(biomass, site:treatment, ev.blade, ev.litter) %>% 
  mutate(sum = ev.blade + ev.litter)
ev.correct <- ev.correct[-c(25,30,37,49),]

# plot and linear model without over estimated values
lm(ev.blade~ev.litter,ev.correct)

biomass <- biomass %>% 
  mutate(sum = (ev.blade + ev.litter))

list <- c(25, 30, 37, 49)
for(i in list){
 biomass[i,"ev.litter"] <- (biomass[i,"sum"]-0.7)/1.092
 biomass[i,"ev.blade"] <- 0.70021 + 0.09216*biomass[i,"ev.litter"] 
}

biomass <- select(biomass, -sum)
rm(i, list, ev.correct)
```
  
*Petasites frigidus*

```{r biomass correction: petfri, results='hide'}

# S-B4-C high "pf.above" value
# remeasured weight using g = LAI/SLA; LAI=3.42, SLA(R.chamamourus)=0.01538

biomass[5,"pf.above"] <- 5.87
```

*Vaccinium vitis-idea*

Plots where new growth was twice as great as old growth were considered to be poorly seperated.
To correct for this, a regression was generated with poor data exepmt. Poor data was then corrected using the
generated regression.
 
Plots that had old growth but no new growth:
 SB1C,SB3NP  
 
Plots that had new growth > old growth:
 SB1P, SB2P, SB4P, SB0N, SB1NP, SB2NP, SB4NP, UB0C, UB0P, UB3P, UB0N, UB4NP  

```{r biomass correction: vacvit, results='hide'}

ggplot(biomass, aes(y=vv.newgrowth, x=vv.oldgrowth))+
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation() 

vv.correct <- anti_join(select(biomass, site:treatment,vv.newgrowth, vv.oldgrowth), 
                       select(biomass,site:treatment, vv.newgrowth, vv.oldgrowth) %>%
                          filter((vv.newgrowth > 2*vv.oldgrowth))) 
vv.correct <- select(biomass, site:treatment,vv.newgrowth, vv.oldgrowth) %>% 
  mutate(sum = vv.newgrowth + vv.oldgrowth)

lm(vv.newgrowth~vv.oldgrowth,vv.correct)

# y = 0.37 + 0.2 x
list <- which((biomass["vv.newgrowth"] > 2*biomass["vv.oldgrowth"]))
count <- 0
for (i in list){
  biomass[i,"vv.oldgrowth"] <- (vv.correct[i,"sum"] - 0.3734) / 1.2028
  biomass[i,"vv.newgrowth"] <- 0.3734 + 0.2028 * biomass[i,"vv.oldgrowth"]
  count = count + 1
}
print(count)

ggplot(biomass, aes(y=vv.newgrowth, x=vv.oldgrowth))+
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation() 

rm(i, list, vv.correct)
```

*Ledum palustre*

L. palustre was sepereated incorrectly. Some had all leaves categorized as new growth where
 others had new growth with no corresponding old growth. Both scenarios are incorrect, so 
 in an attempt to correct it, I further seperated each bag originally labeled "new growth" and "old growth"
 into leaves and stems. This left me with values for "old leaves"" and "old stems"" and "new leaves" 
 and "new stems". From this, I isolated plots which had newLeaves > oldLeaves, which is a sign of
 poor seperation. Then I grouped together oldLeaves, oldStems, newStems and categorized that as 
 "old growth". From this, I determined a correct ratio for old to new and applied that ratio to
 only the plots that had newLeaves > oldLeaves.  
 
```{r biomass correction: ledpal, results='hide'}

ggplot(biomass, aes(y=(lp.newgrowth.leaves + lp.newgrowth.stems) ,
                    x=(lp.oldgrowth.leaves +lp.oldgrowth.stems))) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F)

lp.correct <- anti_join(select(biomass, site:treatment, grep("lp.*", colnames(biomass))),
          select(biomass, site:treatment, grep("lp.*", colnames(biomass))) %>% 
  filter(lp.oldgrowth.leaves < lp.newgrowth.leaves)) %>%
  mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
         lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
         lp.sum = lp.oldgrowth + lp.newgrowth)

ggplot(lp.correct, aes(y=lp.newgrowth ,x=lp.oldgrowth)) +
  geom_point() +
  geom_smooth(method = stats::lm, se = F) +
  stat_regline_equation()

lm(lp.newgrowth~lp.oldgrowth, lp.correct)
# y = 0.2144 + 0.1204 x

biomass <- biomass %>% 
  mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
         lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
         lp.sum = (lp.oldgrowth + lp.newgrowth))

list <- which((biomass["lp.newgrowth.leaves"] > biomass["lp.oldgrowth.leaves"]))
count <- 0
for(i in list){
  biomass[i,"lp.oldgrowth"] <- (biomass[i,"lp.sum"] - 0.2144)/1.2104
  biomass[i,"lp.newgrowth"] <- 0.2144 + 0.1204 * biomass[i,"lp.oldgrowth"]
  count <- count + 1
}
print(count)
biomass <- select(biomass, -lp.newgrowth.leaves, -lp.newgrowth.stems, -lp.oldgrowth.leaves,
                  -lp.oldgrowth.stems, -lp.sum)

rm(i, count, list, lp.correct)
```


```{r biomass scaling, include=T, echo=T}
# If i want to produce graphs without corrections
# biomass <- biomass %>%
#   mutate(lp.oldgrowth = (lp.oldgrowth.leaves + lp.oldgrowth.stems),
#          lp.newgrowth = (lp.newgrowth.leaves + lp.newgrowth.stems),
#          lp.sum = (lp.oldgrowth + lp.newgrowth))
# biomass <- select(biomass, -lp.newgrowth.leaves, -lp.newgrowth.stems, -lp.oldgrowth.leaves,
#                   -lp.oldgrowth.stems, -lp.sum)

small_quad_spp <- c("ev.blade","ev.litter","ev.infl","ev.rhizome","ev.roots","ev.dead.sheath",
                    "ev.decomp.sheath","ev.tussockom","cb.blade","cb.litter","cb.sheath","cb.infl","cb.rhizome",
                    "cb.liveroots","cb.deadroots","vv.newgrowth","vv.oldgrowth","vv.infl","ct.newgrowth",
                    "ct.oldgrowth","ct.dead","ap.newgrowth","ap.oldgrowth","rc.above","rc.litter","rc.below",
                    "rc.infl","pf.above","pf.below","pf.litter","fine.roots","coarse.roots","moss","lichen",
                    "fungi","evergr.litter","decid.litter")

large_quad_spp <- c("bn.leaves","bn.newstems","bn.oldstem","bn.below","bn.infl","sp.newstem","sp.leaves",
                    "sp.oldstem","lp.newgrowth","lp.oldgrowth","lp.dead","lp.infl","lp.below")

biomass[small_quad_spp] <- select(biomass, small_quad_spp) * 25
biomass[large_quad_spp] <- select(biomass, large_quad_spp) * 4

biomass$treatment[biomass$treatment=="CX"] <- "C"

rm(small_quad_spp,large_quad_spp)
```
#### Final Biomass Data

```{r complete biomass and productivity data}

pft.biomass <- mutate(biomass, 
                            sedge = ev.blade + ev.rhizome + cb.blade + cb.rhizome,
                            decid = bn.leaves + bn.newstems + bn.oldstem + bn.infl + sp.leaves + sp.newstem +
                              sp.oldstem,
                            evergr = vv.newgrowth + vv.oldgrowth + vv.infl + ct.newgrowth + ct.oldgrowth +
                              lp.newgrowth + lp.oldgrowth + lp.infl + ap.newgrowth + ap.oldgrowth,
                            forb = rc.above + rc.litter + pf.above,
                            total = sedge + decid + evergr + forb) %>% 
                     select(site:treatment, sedge:forb, total)

pft.anpp <- mutate(biomass,
                     sedge = ev.blade + ev.infl + cb.blade + cb.infl,
                     decid = bn.leaves + bn.newstems + bn.infl + sp.newstem + sp.leaves,
                     evergr = vv.newgrowth + vv.infl + lp.newgrowth + lp.infl + ct.newgrowth +
                       ap.newgrowth,
                     forb = rc.above + rc.litter + rc.infl + pf.above,
                     nonv = moss + lichen,
                     total = sedge + decid + evergr + forb) %>% 
                  select(site:treatment,sedge:forb, nonv, total)
```

```{r ANOVA}
summary(aov(total ~ treatment, data = pft.anpp[pft.anpp$site=="S",]))

aggregate(total ~ site + treatment, mean, data = pft.anpp)

# FROM burn-data-v4
# > summary(aov(anpp ~ site + treatment, data = pluck))
#             Df Sum Sq Mean Sq F value Pr(>F)
# site         1   6307    6307   1.207  0.278
# treatment    4  24678    6169   1.181  0.332
# Residuals   44 229895    5225  

# FROM un-corrected 
#             Df Sum Sq Mean Sq F value Pr(>F)
# site         1    258     258   0.030  0.864
# treatment    3  15645    5215   0.604  0.616
# Residuals   45 388670    8637  

# FROM corrected
#             Df Sum Sq Mean Sq F value Pr(>F)
# site         1   8369    8369   1.726  0.196
# treatment    3  32135   10712   2.209  0.100
# Residuals   45 218189    4849

```

#### Biomass Graphs
```{r productivity percents & correlations}

pft.anpp %>% 
  filter(site=="S") %>% 
  gather(sedge:forb, key="pft", value = "anpp") %>% 
  ggplot(aes(fill=pft, y=anpp, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("severe -- percent total productivity") +
  scale_fill_brewer(palette="Spectral")

pft.anpp %>% 
  filter(site=="U") %>% 
  gather(sedge:forb, key="pft", value = "anpp") %>% 
  ggplot(aes(fill=pft, y=anpp, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("unburned -- percent total productivity")+
  scale_fill_brewer(palette="Spectral")

pft.biomass %>% 
  filter(site=="S") %>% 
  gather(sedge:forb, key="pft", value = "biomass") %>% 
  ggplot(aes(fill=pft, y=biomass, x=treatment))+
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("severe -- percent total biomass") +
  scale_fill_brewer(palette="Spectral")

pft.biomass %>% 
  filter(site=="U") %>% 
  gather(sedge:forb, key="pft", value = "biomass") %>% 
  ggplot(aes(fill=pft, y=biomass, x=treatment))+ 
  geom_bar(position = "fill",stat = "identity", width = 0.5)+
  ggtitle("unburned -- percent total biomass")+
  scale_fill_brewer(palette="Spectral")


```

```{r productivity bar graphs w/error bars}
my_comparisons <- list( c("C", "N"), c("C", "NP"), c("C", "P"))

pft.anpp %>% 
  ggplot(aes(x = treatment, y = total, fill=site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_se, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.format", label.y = -10, method = "t.test") +
  ggtitle("total productivity -- g/m2")

pft.anpp %>% 
  filter(site=="U") %>% 
  ggbarplot(x = "treatment" ,y = "total", add = c("mean_sd","jitter"),
            ggtheme = theme_light(),
            position = position_dodge(0.8), width = 0.5)+
  stat_compare_means(aes(group = treatment), label = "p.format", method = "anova") + 
  stat_compare_means(ref.group = "C", label = "p.format", label.y = -12, method = "t.test")+
  ggtitle("unburned -- total productivity")

pft.anpp %>% 
  filter(site=="S") %>% 
  ggbarplot(x = "treatment" ,y = "total", add = c("mean_sd","jitter"),
            ggtheme = theme_light(),
            position = position_dodge(0.8), width = 0.5)+
  stat_compare_means(aes(group = treatment), label = "p.format", method = "anova") + 
  stat_compare_means(ref.group = "C", label = "p.format", label.y = -12, method = "t.test") +
  ggtitle("severe -- total productivity") +
  ggrepel::geom_text_repel(aes(label = block))

biomass %>% 
  filter(site=="S", block == 3, treatment == "NP")

```

```{r productivity bar graphs w/error bars}
pft.anpp %>% 
  ggplot(aes(x = treatment, y = decid, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("decid productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = sedge, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("sedge productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = evergr, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("evergr productivity -- g/m2")

pft.anpp %>% 
  ggplot(aes(x = treatment, y = forb, fill = site)) +
  stat_summary(fun.y = mean, geom = "bar",position = position_dodge(),width=0.5) + 
  stat_summary(fun.data = mean_sd, geom = "errorbar",position = position_dodge(0.5), width=0.15)+
  stat_compare_means(aes(group = site), label = "p.signif", label.y = -5)+
  ggtitle("forb productivity -- g/m2")
```













